---
title: "Midterm_project"
author: "æ—è‚²è±"
date: "`r Sys.time()`"
output:
  pdf_document: default
  html_document:
    highlight: pygments
    theme: flatly
    css: style.css
---
<br>

### å°ˆæ¡ˆèªªæ˜
1. å°äº¤æ˜“èˆ‡é¡§å®¢è³‡æ–™é€²è¡Œæ¢ç´¢ï¼Œæ‰¾å‡ºæœ‰åˆ©çš„åˆ†æç‰¹å¾µ
2. æ‰¾å‡ºä¸»è¦çš„å®¢ç¾¤ï¼Œä¸¦é‡å°æ­¤å®¢ç¾¤çš„ç‰¹å¾µæ“¬å®šè¡ŒéŠ·æ–¹æ¡ˆ

### è³‡æ–™å½™æ•´æµç¨‹

<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/aggregation.jpg)
</center>

<hr>

### 1. äº¤æ˜“é …ç›®è¨ˆéŒ„ï¼š`Z`

```{r setup, echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=T))
knitr::opts_chunk$set(paged.print=FALSE, comment = NA)
pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd, plotly)
```

##### 1.1 è®€é€²è³‡æ–™
```{r}
Z = read_csv("data/ta_feng_all_months_merged.csv") %>% 
  data.frame %>% setNames(c(
    "date","cust","age","area","cat","prod","qty","cost","price"))
nrow(Z)
```

```{r}
tibble(Z)
```

##### æ—¥æœŸæ ¼å¼è½‰æ›
```{r fig.height=3.2, fig.width=7}
Z$date = as.Date(Z$date, format="%m/%d/%Y")
par(cex=0.8)
hist(Z$date,'weeks',freq=T,las=2)
```

##### å¹´é½¡å±¤ç´šã€éƒµéå€è™Ÿ
```{r}
age.group = c("<25","25-29","30-34","35-39","40-44",
              "45-49","50-54","55-59","60-64",">65")
Z$age = c(paste0("a",seq(24,69,5)),"a99")[match(Z$age,age.group,11)]
Z$area = paste0("z",Z$area)
```

<center>
![Fig-2:éƒµéå€è™Ÿ](fig/zipcode.png)
</center>


```{r fig.height=2.5, fig.width=7}
par(mfrow=c(1,2),cex=0.7)
table(Z$age, useNA='ifany') %>% barplot(main="Age Groups", las=2)
table(Z$area,useNA='ifany') %>% barplot(main="Areas", las=2)
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Quantile of Variables
sapply(Z[,7:9], quantile, prob=c(.99, .999, .9995))
```

```{r}
# Remove Outliers
Z = subset(Z, qty<=24 & cost<=3800 & price<=4000) 
nrow(Z)  
```

##### å½™ç¸½è¨‚å–® Assign Transaction ID
æŠŠæ¯ä¸€å¤©ã€æ¯ä¸€ç‚ºé¡§å®¢çš„äº¤æ˜“é …ç›®å½™ç¸½ç‚ºä¸€å¼µè¨‚å–®
```{r}
Z$tid = group_indices(Z, date, cust) # same customer same day
```

##### è³‡æ–™ç¸½è¦½
```{r}
# No. cust, cat, prod, tid
sapply(Z[c("cust","cat","prod","tid")], n_distinct)
```
<br><hr>

### 2. äº¤æ˜“è¨ˆéŒ„ï¼š`X`

##### äº¤æ˜“è³‡æ–™å½™æ•´
```{r}
X = Z %>% group_by(tid) %>% summarise(
  date = min(date),          # äº¤æ˜“æ—¥æœŸ  
  cust = min(cust),          # é¡§å®¢ ID
  age = min(age),            # é¡§å®¢ å¹´é½¡ç´šåˆ¥
  area = min(area),          # é¡§å®¢ å±…ä½å€åˆ¥
  items = n(),               # äº¤æ˜“é …ç›®(ç¸½)æ•¸
  pieces = sum(qty),         # ç”¢å“(ç¸½)ä»¶æ•¸
  total = sum(price),        # äº¤æ˜“(ç¸½)é‡‘é¡
  gross = sum(price - cost)  # æ¯›åˆ©
) %>% data.frame
nrow(X) # 119422 
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Check Quantile & Remove Outliers
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
# Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) # 119328
```

##### äº¤æ˜“æ‘˜è¦
```{r}
summary(X)    
```

##### æ¯å‘¨äº¤æ˜“æ¬¡æ•¸
```{r fig.height=3, fig.width=7}
par(cex=0.8)
hist(X$date, "weeks", freq=T, las=2, main="No. Transaction per Week")
```
<br><hr>



### 3. é¡§å®¢è³‡æ–™ï¼š`A`

##### é¡§å®¢è³‡æ–™å½™æ•´
```{r}
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = min(age),     # age group
    area = min(area),   # area code
  ) %>% data.frame      
nrow(A) # 32241
```

```{r fig.height=2.5, fig.width=7.2}
par(mfrow=c(1,2),cex=0.7)
table(A$age, useNA='ifany') %>% barplot(main="Age Groups",las=2)
table(A$area, useNA='ifany') %>% barplot(main="Areas",las=2)                
```

##### é¡§å®¢æ‘˜è¦
```{r}
summary(A) 
```

```{r fig.height=8}
par(mfrow=c(3,2), mar=c(3,3,4,2))
for(x in c('r','s','f','m')) 
  hist(A[,x],freq=T,main=x,xlab="",ylab="",cex.main=2)
hist(pmin(A$f,10),0:10,freq=T,xlab="",ylab="",cex.main=2)
hist(log(A$m,10),freq=T,xlab="",ylab="",cex.main=2)
```

ğŸŒ· **åæ…‹åˆ†ä½ˆçš„è™•ç†æ–¹æ³•**

+ å°æ•¸è½‰æ› - `log(A$m, 10)`
+ å›ºå®šä¸Šé™ - `pmin(A$f, 10)`

<br> 

##### Check & Save
```{r}
is.na(Z) %>% colSums
```

```{r}
is.na(X) %>% colSums
```

```{r}
is.na(A) %>% colSums
```

```{r}
A0 = A; X0 = X; Z0 = Z
```

ç¢ºèªè³‡æ–™æ²’æœ‰ç¼ºå¤±å€¼ä¹‹å¾Œï¼Œå°‡é¡§å®¢è³‡æ–™å­˜é€²A0ï¼Œäº¤æ˜“è³‡æ–™Xå­˜é€²X0ï¼ŒåŸå§‹è³‡æ–™Zå­˜é€²Z0

<br><hr>

### 4. è³‡æ–™æ¢ç´¢

##### å¹´é ˜èˆ‡åœ°ç†å€éš”çš„é—œè¯æ€§
ä½¿ç”¨é¦¬è³½å…‹åœ–æª¢è¦–åˆ—é€£è¡¨çš„é—œè¯æ€§(Association between Categorial Variables)

- æ–¹å¡Šå¤§å°ä»£è¡¨è©²é¡åˆ¥çµ„åˆçš„æ•¸é‡
- ç´…(è—)è‰²ä»£è¡¨è©²é¡åˆ¥çµ„åˆçš„æ•¸é‡é¡¯è‘—å°(å¤§)æ–¼æœŸæœ›å€¼
- æœŸæœ›å€¼å°±æ˜¯é‚Šéš›æ©Ÿç‡(å¦‚ä¸Šæ–¹çš„ç›´æ¢åœ–æ‰€ç¤º)çš„ä¹˜ç©
- å¡æ–¹æª¢å®š(é¡åˆ¥è®Šæ•¸çš„é—œè¯æ€§æª¢å®š)çš„på€¼é¡¯ç¤ºåœ¨åœ–ç¤ºæœ€ä¸‹æ–¹
- p-value < 2.22e-16 : age èˆ‡ area ä¹‹é–“æœ‰é¡¯è‘—çš„é—œè¯æ€§

```{r fig.height=6, fig.width=7.5}
MOSA = function(formula, data) mosaic(formula, data, shade=T, 
  margins=c(0,1,0,0), labeling_args = list(rot_labels=c(90,0,0,0)),
  gp_labels=gpar(fontsize=9), legend_args=list(fontsize=9),
  gp_text=gpar(fontsize=7),labeling=labeling_residuals)

MOSA(~age+area, A0)
```


##### å¹´é½¡å€éš”ç‰¹å¾µ
```{r}
A0 %>% group_by(age) %>% summarise(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=age, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=age)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")
```
```{r}
mean(A0$age == "a99")
```
**ç”±æ–¼a99(æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢)äººæ•¸ä¸å¤šï¼Œè€Œä¸”ç‰¹å¾µå¾ˆç¨ç‰¹ï¼Œæ¢ç´¢æ™‚æˆ‘å€‘å¯ä»¥è€ƒæ…®æ¿¾æ‰é€™ç¾¤é¡§å®¢**

```{r}
A0 %>% filter(age!="a99") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢('a99')
  group_by(age) %>% summarise(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=age, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=age)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")
```

##### åœ°ç†å€éš”ç‰¹å¾µ
```{r}
A0 %>% filter(age!="a99") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢('a99')
  group_by(area) %>% summarise(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=area, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=area)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")
```
<br><hr>

##### ä¸»è¦åˆ†æ
â€» ã€Œå¹´é½¡ã€èˆ‡ã€Œåœ°å€ã€ä¹‹é–“æœ‰å¾ˆé«˜çš„é—œè¯æ€§  
â€ƒ â€ƒ Â§ å—æ¸¯(z115)30~40æ­²çš„é¡§å®¢æ¯”ç‡æ¯”è¼ƒä½  
â€ƒ â€ƒ Â§ æ±æ­¢(z221)ã€å…§æ¹–(z114)å’Œå…¶ä»–(zOthers)30~40æ­²çš„é¡§å®¢æ¯”ç‡æ¯”è¼ƒé«˜  
  
â€» ã€Œå¹³å‡è³¼è²·æ¬¡æ•¸ã€å’Œã€Œå¹³å‡å®¢å–®åƒ¹ã€ä¹‹é–“æœ‰æ˜é¡¯çš„è² ç›¸é—œ  
â€ƒ â€ƒ Â§ ä½çš„é (è¿‘)çš„äººæ¯”è¼ƒå°‘(å¸¸)ä¾†è²·ã€ä½†æ¯ä¸€æ¬¡è²·çš„æ¯”è¼ƒå¤š(å°‘)  
â€ƒ â€ƒ Â§ 30~40æ­²(å¹´è¼•å’Œå¹´é•·)çš„äººæ¯”è¼ƒå°‘(å¸¸)ä¾†è²·ã€ä½†æ¯ä¸€æ¬¡è²·çš„æ¯”è¼ƒå¤š(å°‘)  


##### å“é¡å’Œå¹´é½¡ã€åœ°å€çš„é—œè¯æ€§
```{r}
top20 = tapply(Z0$qty,Z0$cat,sum) %>% sort %>% tail(20) %>% names
```

```{r}
MOSA(~age+cat, Z0[Z0$cat %in% top20,])
```
```{r}
MOSA(~cat+area, Z0[Z0$cat %in% top20,])
```
  
**ä¸åŒå¹´é½¡ã€åœ°å€çš„é¡§å®¢å–œæ­¡è²·çš„å“é¡çœ‹ä¾†ä¹Ÿä¸å¤ªä¸€æ¨£**
 

##### å‘¨æœ«èˆ‡å‘¨é–“
```{r}
X0$wday = format(X0$date, "%u")
par(cex=0.7, mar=c(2,3,2,1))
table(X0$wday) %>% barplot(main="No. Transactions in Week Days")
```
  
##### å¹´é½¡èˆ‡è³¼ç‰©æ—¥çš„é—œè¯æ€§
```{r}
MOSA(~age+wday, X0)
```
```{r}
df = Z0 %>% filter(cat %in% top20) %>% mutate(wday = format(date, '%u'))
MOSA(~cat+wday, df)
```

##### å“é¡åˆ†æ
- ç²åˆ©è²¢ç»(profit)æœ€å¤§çš„100å€‹å“é¡(cat)
```{r}
col6 = c('seagreen','gold','orange',rep('red',3))
gg= group_by(Z0, cat) %>% summarise(
  solds = n(), qty = sum(qty), rev = sum(price), cost = sum(cost), 
  profit = rev - cost, margin = 100*profit/rev
  ) %>% 
  top_n(100, profit) %>% 
  ggplot(aes(x=margin, y=rev, col=profit, label=cat)) + 
  geom_point(size=2,alpha=0.8) + scale_y_log10() + 
  scale_color_gradientn(colors=col6) +
  theme_bw()
ggplotly(gg)
```

<br><hr>
### 5.è¡ŒéŠ·ç­–ç•¥æ“¬å®š
**èƒŒæ™¯**    
æˆ‘å€‘å‡è¨­é€™å®¶é‡è²©åº—å¤§åŒ—ç™¾è²¨é–‹è¨­åœ¨æ±æ­¢èˆ‡å—æ¸¯ç­‰åœ°å€ï¼Œè€Œè¼ƒå¤šçš„é¡§å®¢å¹´é½¡éƒ½è½åœ¨30-44æ­²ï¼Œä¸¦ä¸”å–œæ­¡åœ¨å‘¨æœ«æ™‚é€ è¨ªï¼Œè€ƒé‡åˆ°æ­¤æ¶ˆè²»æ—ç¾¤äººæ•¸è¼ƒå¤šèˆ‡è³¼è²·å¹³å‡å®¢å–®åƒ¹æœ€é«˜ï¼Œå› æ­¤æˆ‘å€‘å°‡æ­¤è¨‚ç‚ºæˆ‘å€‘çš„TA

ç”±ä¸Šé¢é¦¬è³½å…‹åœ–å¾—çŸ¥ï¼Œå¯ç™¼ç¾å—æ¸¯30-40æ­²çš„æ¶ˆè²»å®¢ç¾¤äººæ•¸è¼ƒä½ï¼Œæ‰€ä»¥æˆ‘å€‘å°‡è¡ŒéŠ·ç›®æ¨™è¨‚ç‚ºã€Œæå‡å—æ¸¯åœ°å€30-40æ­²é¡§å®¢æ¯”ç‡ã€ ï¼Œè€Œæˆ‘å€‘æ¨æ¸¬é€ æˆé€™æ¨£çš„ç¾è±¡å¯èƒ½æœ‰ä»¥ä¸‹**å››é»åŸå› **:

1. ç”¢å“çµ„åˆæˆ–ç”¢å“è²©å”®æ–¹å¼ä¸å¤ å¸å¼•äºº
2. åº—é¢åœ°ç†ä½ç½®ä¸æ˜“åˆ°é”
3. é™„è¿‘å¯èƒ½æœ‰å…¶ä»–åŒæ¥­ç«¶çˆ­å°æ‰‹
4. åˆ†åº—è³‡è¨Šè¼ƒå°‘äººçŸ¥æ›‰

**é‡å°ç¬¬ä¸€é»åŸå› æœ¬çµ„é è¨ˆé€éåˆ†æã€Œç”¢å“çµ„åˆã€ï¼Œé€²ä¸€æ­¥æå‡ºçš„ç­–ç•¥:**

- éŠ·å”®é‡æœ€é«˜çš„ç”¢å“ > æ˜æ˜Ÿç†±éŠ·å•†å“çµ„ï¼šé¸å‡ºå“ç‰Œç†±éŠ·å•†å“é€²è¡Œè²©å”®ï¼Œä»¥ã€Œæ˜æ˜Ÿæš¢éŠ·å•†å“ã€ã€ã€ŒéŠ·å”®å† è»å•†å“ã€ç­‰ç­‰çš„çµ„åˆåç¨±å¸å¼•æ¶ˆè²»è€…ã€‚
- è³£ä¸å‡ºå»çš„å•†å“ > æ­é…è´ˆå“ï¼šç”±æ–¼æ–°å“æ˜¯æ¶ˆè²»è€…è¼ƒä¸ç†Ÿæ‚‰çš„ç”¢å“ï¼Œè¦æé«˜å¤§å®¶çš„ä¸‹å–®æ„é¡˜ï¼Œå¯ä»¥é€éè´ˆé€ä¸€äº›ç›®æ¨™æ¶ˆè²»è€…ç¾¤ï¼ˆTA) -
- æœ‰èˆˆè¶£çš„æ±è¥¿ç•¶è´ˆå“ï¼Œå»å¸å¼•æ¶ˆè²»è€…è³¼å…¥ã€‚
- èˆ‡ç‰¹è‰²å“ç‰Œï¼ˆä¾‹å¦‚å°è¾²å“ç‰Œã€æ˜Ÿç´šé£¯åº—ç­‰ç­‰ï¼‰åˆä½œï¼Œæ¨å‡ºå¤§åŒ—ç™¾è²¨(å—æ¸¯åº—)å°ˆå±¬è¯åå•†å“ï¼Œå¢åŠ æ¶ˆè²»è€…çš„è³¼ç‰©é¸æ“‡
èˆ‰è¾¦è¦ªå­æ´»å‹•ex ï¼šå°å°åº—é•·æˆ–æ˜¯è¦ªå­DIYå¸å¼•å°å®¶åº­ä¾†è¨ª

**é‡å°ç¬¬äºŒé»åŸå› æˆ‘å€‘æå‡ºä»¥ä¸‹çš„ç­–ç•¥:**
- å› ç‚ºæ­¤æ—ç¾¤å¤šç‚ºå‡æ—¥æ¶ˆè²»ã€é–‹è»Šã€å®¶åº­æ¡è³¼ï¼Œæˆ‘å€‘æ¨è«–åœ¨å—æ¸¯åœ°å€çš„åº—å®¶å‘¨é‚Šå¯èƒ½æœ‰åœè»Šä½ä¸è¶³çš„å•é¡Œï¼Œæ‰€ä»¥èªç‚ºå¯ä»¥è·Ÿé™„è¿‘åœè»Šå ´åˆä½œï¼Œè—‰ç”±å¢åŠ åœè»Šä½è§£æ±ºåº—é¢ä¸æ˜“åˆ°é”å•é¡Œ

**é‡å°ç¬¬ä¸‰ã€å››é»åŸå› ï¼Œæˆ‘å€‘æå‡ºä»¥ä¸‹ç­–ç•¥:**
- èˆ‡é™„è¿‘äº”å…¬é‡Œçš„åº—å®¶é€²è¡Œè¯ç›Ÿè¡ŒéŠ·
- é–‹è¨­ç²‰çµ²å°ˆæ¥­ã€æˆç«‹ç¤¾ç¾¤æ¨æ’­å„ªæƒ è³‡è¨Š
