---
title: "Final_Project"
author: "Shelly Lin"
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: style.css
---
<br>

### å°ˆæ¡ˆèªªæ˜
1. å°ç¶“ç‡Ÿç¾æ³é€²è¡Œèªªæ˜ã€‚
2. å°é¸æ“‡çš„ç›®æ¨™å®¢ç¾¤é€²è¡Œé æ¸¬ï¼Œåƒæ˜¯æ¯ä½é¡§å®¢çš„å›è³¼æ©Ÿç‡ã€é æœŸç‡Ÿæ”¶ã€é æœŸç²åˆ©ä»¥åŠçµ‚ç”Ÿåƒ¹å€¼ã€‚
3. åˆ©ç”¨è¡ŒéŠ·å·¥å…·èªªæ˜å¦‚ä½•æå‡æˆ–æ˜¯ç¶­æŒå®¢ç¾¤çš„ç‰¹é»ï¼Œä¸¦ç­è§£é€éæ­¤å·¥å…·çš„æ‰€å¾—åˆ°é æœŸçš„ç¸½æ•ˆç›Šã€‚


### è³‡æ–™å½™æ•´æµç¨‹

<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/aggregation.jpg)

</center>

<hr>

### 1.äº¤æ˜“é …ç›®ç´€éŒ„:Z
```{r setup, echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=T))
knitr::opts_chunk$set(paged.print=FALSE, comment = NA)
pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd,plotly,tidyr,latex2exp,Matrix)
```


##### è®€é€²è³‡æ–™
```{r}
Z = read_csv("data/ta_feng_all_months_merged.csv") %>% 
  data.frame %>% setNames(c(
    "date","cust","age","area","cat","prod","qty","cost","price"))
```
```{r}
nrow(Z)
```
```{r}
tibble(Z)
```

##### æ—¥æœŸæ ¼å¼è½‰æ›
```{r fig.height=3.2, fig.width=7}
Z$date = as.Date(Z$date, format="%m/%d/%Y")
par(cex=0.8)
hist(Z$date,'weeks',freq=T,las=2)
```

##### å¹´é½¡å±¤ç´šã€éƒµéå€è™Ÿ  
ç­è§£é¡§å®¢çš„å¹´é½¡å®¢ç¾¤èˆ‡åˆ†å¸ƒåœ°å€
```{r}
age.group = c("<25","25-29","30-34","35-39","40-44",
              "45-49","50-54","55-59","60-64",">65")
Z$age = c(paste0("a",seq(24,69,5)),"a99")[match(Z$age,age.group,11)]
Z$area = paste0("z",Z$area)
```

<center>
![Fig-2:éƒµéå€è™Ÿ](fig/zipcode.png)
</center>

```{r fig.height=2.5, fig.width=7}
par(mfrow=c(1,2),cex=0.7)
table(Z$age, useNA='ifany') %>% barplot(main="Age Groups", las=2)
table(Z$area,useNA='ifany') %>% barplot(main="Areas", las=2)
```
  
ç¶“ç”±ä¸Šåœ–å¯ä»¥ç™¼ç¾é¡§å®¢å¹´é½¡å¤šç‚º29-44ç‚ºä¸»ï¼Œè€Œå€åŸŸå‰‡æ˜¯z115(å—æ¸¯)èˆ‡z221(æ±æ­¢)ç‚ºä¸»ã€‚  


##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Quantile of Variables
sapply(Z[,7:9], quantile, prob=c(.99, .999, .9995))
```
```{r}
# Remove Outliers
Z = subset(Z, qty<=24 & cost<=3800 & price<=4000) 
nrow(Z)  
```

##### å½™ç¸½è¨‚å–®  
æŠŠæ¯ä¸€å¤©ã€æ¯ä¸€å€‹é¡§å®¢çš„äº¤æ˜“é …ç›®å½™ç¸½ç‚ºä¸€å¼µè¨‚å–®
```{r}
Z$tid = group_indices(Z, date, cust) # same customer same day
```
##### è³‡æ–™ç¸½è¦½
```{r}
# No. cust, cat, prod, tid
sapply(Z[c("cust","cat","prod","tid")], n_distinct)
```

### 2.äº¤æ˜“ç´€éŒ„:X
##### äº¤æ˜“è³‡æ–™å½™æ•´
```{r}
X = Z %>% group_by(tid) %>% summarise(
  date = min(date),          # äº¤æ˜“æ—¥æœŸ  
  cust = min(cust),          # é¡§å®¢ ID
  age = min(age),            # é¡§å®¢ å¹´é½¡ç´šåˆ¥
  area = min(area),          # é¡§å®¢ å±…ä½å€åˆ¥
  items = n(),               # äº¤æ˜“é …ç›®(ç¸½)æ•¸
  pieces = sum(qty),         # ç”¢å“(ç¸½)ä»¶æ•¸
  total = sum(price),        # äº¤æ˜“(ç¸½)é‡‘é¡
  gross = sum(price - cost)  # æ¯›åˆ©
) %>% data.frame
nrow(X)
```
##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Check Quantile & Remove Outliers
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
# Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) # 119328
```

##### äº¤æ˜“æ‘˜è¦
```{r}
summary(X) 
```

##### æ¯å‘¨äº¤æ˜“æ¬¡æ•¸
```{r}
par(cex=0.8)
hist(X$date, "weeks", freq=T, las=2, main="No. Transaction per Week")
```

### 3.é¡§å®¢è³‡æ–™:A
##### é¡§å®¢è³‡æ–™å½™æ•´
```{r}
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% group_by(cust) %>% summarise(
    TID = min(tid),
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = min(age),     # age group
    area = min(area),   # area code
  ) %>% data.frame      
nrow(A) # 32241
```

```{r}
par(mfrow=c(1,2),cex=0.7)
table(A$age, useNA='ifany') %>% barplot(main="Age Groups",las=2)
table(A$area, useNA='ifany') %>% barplot(main="Areas",las=2)    
```


##### é¡§å®¢æ‘˜è¦
```{r}
summary(A) 
```

```{r}
par(mfrow=c(3,2), mar=c(3,3,4,2))
for(x in c('r','s','f','m')) 
  hist(A[,x],freq=T,main=x,xlab="",ylab="",cex.main=2)
hist(pmin(A$f,10),0:10,freq=T,xlab="",ylab="",cex.main=2)
hist(log(A$m,10),freq=T,xlab="",ylab="",cex.main=2)
```

##### 4.Check & Save  
å°‡å‰›å‰›è™•ç†å®Œçš„è³‡æ–™å…¨éƒ¨é‡æ–°å„²å­˜ã€‚  
```{r}
is.na(Z) %>% colSums
```

```{r}
is.na(X) %>% colSums
```

```{r}
is.na(A) %>% colSums
```

```{r}
A0 = A; X0 = X; Z0 = Z
save(Z0, X0, A0, file="data/tf0.rdata")
```

##### é¡åˆ¥è³‡æ–™çš„åˆ†é¡çµ±è¨ˆ
```{r}
mosaic(~area+age, data=A, shade=T)
```

ç”±æ–¼a99(æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢)äººæ•¸ä¸å¤šï¼Œè€Œä¸”ç‰¹å¾µå¾ˆç¨ç‰¹ï¼Œæ¢ç´¢æ™‚æˆ‘å€‘å¯ä»¥è€ƒæ…®æ¿¾æ‰é€™ç¾¤é¡§å®¢
```{r}
A0 %>% filter(age!="a99") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢('a99')
  group_by(age) %>% summarise(
  TID = min(TID),
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=age, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=age)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")
```
ç¶“ä¸Šé¢çš„æ³¡æ³¡åœ–é¡¯ç¤ºï¼Œå¹³å‡å®¢å–®åƒ¹è¼ƒé«˜çš„å®¢ç¾¤ç‚ºa34èˆ‡a39ã€‚

##### åœ°ç†å€éš”ç‰¹å¾µ
```{r}
A0 %>% filter(age!="a99") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢('a99')
  group_by(area) %>% summarise(
  TID = min(TID),
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=area, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=area)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")
```

æ•…ç¶œä¸Šé¢é¡¯ç¤ºçš„å…©å¼µæ³¡æ³¡åœ–åˆ†æï¼Œæˆ‘å€‘å°‡å¹´é½¡èˆ‡åœ°å€ä½œç‚ºæˆ‘å€‘çš„TAç¯©é¸æ¢ä»¶ã€‚
é¦–å…ˆï¼Œæˆ‘å€‘å…ˆé¸å‡ºäº†a34èˆ‡a39çš„åˆä½µçµ„åˆï¼Œå› ç‚ºå¾ç¬¬ä¸€å¼µæ³¡æ³¡åœ–å¯çœ‹å‡ºæ­¤çµ„åˆçš„å¹³å‡å®¢å–®åƒ¹ç‚ºæœ€é«˜ï¼Œæ•…æ­¤çµ„åˆç‚ºä¸€å€‹å¯åˆ©ç”¨è¡ŒéŠ·è€Œæé«˜æ”¶ç›Šçš„å°è±¡ã€‚

å†ä¾†ï¼Œæˆ‘å€‘ä¾åœ°å€åˆ†å¸ƒå†é¸å‡ºäº†z115èˆ‡z221ï¼Œè€Œç†ç”±æ˜¯z115åœ¨ä¸Šè¿°çš„å¹´é½¡çµ„åˆçš„æ¶ˆè²»äººæ•¸è¼ƒå°‘ï¼Œæˆ‘å€‘å¸Œæœ›åˆ©ç”¨è¡ŒéŠ·æ‰‹æ³•ä¾†æ‹“å±•æ½›åœ¨å®¢ç¾¤ï¼Œä¸¦ä¸”æå‡åœ¨Z115çš„æ¶ˆè²»äººæ•¸;z221åœ°å€å‰‡åœ¨ä¸Šè¿°å¹´é½¡çš„çµ„åˆçš„æ¶ˆè²»äººæ•¸è¼ƒé«˜ï¼Œæ•…æˆ‘å€‘å¸Œæœ›å°‡æ­¤å¸¸å®¢æ—ç¾¤ç¹¼çºŒç•™ä½ï¼Œå†æé«˜ä»–å€‘å°TaFengçš„å¿ èª åº¦ã€‚

```{r}
z221_cu = subset(A0, area == "z221" & (age == "a34" | age == "a39"))#3653äºº
```

```{r}
z115_cu =subset(A0, area == "z115" &(age == "a34" | age == "a39"))#3550äºº
```
é€™è£¡å°‡å…©ç¾¤TAç¯©é¸å‡ºä¾†ï¼Œè€Œå¯çœ‹åˆ°å…©ç¾¤äººæ•¸ç‚ºç¸½é¡§å®¢çš„ååˆ†ä¹‹ä¸€ï¼Œæœ‰é”åˆ°åœ¨è¡ŒéŠ·äººæ•¸æ¢ä»¶çš„æ¨™æº–

<hr>


### è³‡æ–™æ•´ç†
<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/preparation.jpg)
</center>

### 1.è£½ä½œé æ¸¬è®Šæ•¸
1. è³‡æ–™å‚™è¨»:    
- Z0:åŸå§‹äº¤æ˜“é …ç›®  
- X0:äº¤æ˜“(æ¯ä¸€å¼µè¨‚å–®æœ‰å¤šå€‹é …ç›®ï¼Œå«æœ‰ç”¢å“ç¨®é¡ã€å“é …)  
- A0:é¡§å®¢    
2.ä½œæ³•:    
- ç§»é™¤æœ€å¾Œä¸€æœŸ(åˆ†å‰²æ—¥æœŸä¹‹å¾Œ)çš„è³‡æ–™  

```{r}
feb01 = as.Date("2001-02-01")   # è³‡æ–™åˆ†å‰²æ—¥æœŸ 
Z = subset(Z0, date < feb01)    # 618212 é …ç›®
```

##### 1.é‡æ–°åŒ¯æ•´äº¤æ˜“ç´€éŒ„
```{r}
X = group_by(Z, tid) %>% summarise(
  date = first(date),  # date of transaction
  cust = first(cust),  # customer id
  age = first(age),    # age group
  area = first(area),  # area group
  items = n(),                # number of items
  pieces = sum(qty),          # number of pieces
  total = sum(price),         # total amount
  gross = sum(price - cost)   # raw profit
  ) %>% data.frame  # 88387 äº¤æ˜“ç­†æ•¸
```

```{r}
summary(X)
```

##### ç§»é™¤ä¸åˆç†çš„é›¢ç¾¤è³‡æ–™
```{r}
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
X = subset(X, items<=64 & pieces<=98 & total<=11260) # 88387 -> 88295
```

##### é‡æ–°åŒ¯æ•´é¡§å®¢è³‡æ–™
```{r}
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% 
  group_by(cust) %>% summarise(
    TID = min(tid),
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frequency
    m = mean(total),    # monetary(å¹³å‡å®¢å–®åƒ¹)
    rev = sum(total),   # total revenue contribution(ç¸½ç‡Ÿæ”¶è²¢ç»)
    raw = sum(gross),   # total gross profit contribution(ç¸½æ·¨åˆ©è²¢ç»)
    age = age[1],       # age group
    area = area[1],     # area code
  ) %>% data.frame      # 28584 é¡§å®¢
nrow(A)
```

### 2.è£½ä½œé æ¸¬è®Šæ•¸
##### åŒ¯æ•´æœ€å¾Œä¸€æœŸçš„è³‡æ–™
```{r}
feb = filter(X0, date>= feb01) %>% group_by(cust) %>% 
  summarise(amount = sum(total))  # 16900
```

- feb$amountä¹‹ä¸­æœ‰æœ€å¾Œä¸€æœŸä¾†è²·éçš„16,900ä½é¡§å®¢çš„ç‡Ÿæ”¶è²¢ç»    
- å°‡feb$amountåŒ¯å…¥A
```{r}
A = merge(A, feb, by="cust", all.x=T)
```

##### The Target for Classification - A$buy  
- A$amountæ˜¯NAä»£è¡¨é€™ä½é¡§å®¢æœ€å¾Œä¸€æœŸæ²’ä¾†è²·
- A$amountä¸æ˜¯NAä»£è¡¨é€™ä½é¡§å®¢æœ€å¾Œä¸€æœŸæœ‰ä¾†è²·é
```{r}
A$buy = !is.na(A$amount)  
table(A$buy, !is.na(A$amount))
```

##### 3. ç¸½çµè³‡æ–™é›†çš„å…§å®¹
```{r}
summary(A)
```

```{r}
#z115_caåœ¨2æœˆçš„è³¼è²·äººæ•¸
z115_cu_A1 = matrix(NA, nrow(z115_cu),ncol(z115_cu))
z115_cu_A1 = A[A$TID %in% z115_cu$TID,]
table(z115_cu_A1$buy)
```
ä¾ä¸Šé¢çµæœï¼Œz221(æ±æ­¢)çš„å®¢ç¾¤åœ¨2æœˆçš„è³¼è²·äººæ•¸ç‚º1623ã€‚  

```{r}
#z221_cuåœ¨2æœˆçš„è³¼è²·äººæ•¸
z221_cu_A1 = matrix(NA, nrow(z221_cu),ncol(z221_cu))
z221_cu_A1 = A[A$TID %in% z221_cu$TID,]
table(z221_cu_A1$buy)
```
ä¾ä¸Šé¢çµæœï¼Œz221(å—æ¸¯)çš„å®¢ç¾¤åœ¨2æœˆçš„è³¼è²·äººæ•¸ç‚º1808ã€‚  

<hr>

### å»ºç«‹æ¨¡å‹
<center>
![Fig-3:å»ºç«‹æ¨¡å‹](fig/modeling.jpg)
</center>

##### 1.åˆ†å‰²è¨“ç·´æ¸¬è©¦(TR)èˆ‡æ¸¬è©¦è³‡æ–™(TS)
Data for è³¼è²·æ©Ÿç‡æ¨¡å‹èˆ‡è³¼è²·é‡‘é¡æ¨¡å‹   
- Aä¹‹ä¸­æ¯ä¸€ç­†è³‡æ–™éƒ½å¯ä»¥æ‹¿ä¾†åšè³¼è²·æ©Ÿç‡æ¨¡å‹  
- ä½†åªæœ‰A$amountæœ‰å€¼çš„è³‡æ–™å¯ä»¥æ‹¿ä¾†åšè³¼è²·é‡‘é¡æ¨¡å‹ : A2  
- Aå’ŒA2éƒ½éœ€è¦åœ¨ç›¸åŒçš„ç›®æ¨™è®Šæ•¸åˆ†ä½ˆåˆ‡å‰²æˆè¨“ç·´æ¸¬è©¦(TR)èˆ‡æ¸¬è©¦è³‡æ–™(TS)  
- æˆ‘å€‘åˆ†åˆ¥ç”¨caTools::sample.split()å’Œéš¨æ©ŸæŠ½æ¨£(sample)ä¾†è£½ä½œåˆ†å‰²å‘é‡:splï¼Œspl2  

**z115çš„è³¼è²·æ©Ÿç‡æ¨¡å‹**
```{r}
#z115çš„è³¼è²·æ©Ÿç‡æ¨¡å‹
z115_X1 = subset(X, cust %in% z115_cu_A1$cust & date < as.Date("2001-02-01"))
z115_Z1 = subset(Z, cust %in% z115_cu_A1$cust & date < as.Date("2001-02-01"))
set.seed(2018)
z115_spl = sample.split(z115_cu_A1$buy, SplitRatio = 0.7)
c(nrow(z115_cu_A1),sum(z115_spl),sum(!z115_spl))
```


```{r}
tapply(z115_cu_A1$buy,z115_spl,mean)
```

```{r}
cbind(z115_cu_A1, z115_spl) %>% filter(buy) %>%
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=z115_spl), alpha=0.5)
```


**z115çš„è³¼è²·æ©Ÿç‡é‡‘é¡**
```{r}
z115_A2 = subset(z115_cu_A1, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(z115_A2)
#éš¨æ©ŸæŠ½æ¨£è£½ä½œåˆ†å‰²å‘é‡spl2
set.seed(2018); z115_spl2 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(z115_A2), sum(z115_spl2), sum(!z115_spl2))
```

```{r}
mean(z115_spl2)
```

```{r}
cbind(z115_A2, z115_spl2) %>% 
  ggplot(aes(x=amount)) + geom_density(aes(fill=z115_spl2), alpha=0.5)
```



**z221è³¼è²·æ©Ÿç‡æ¨¡å‹**
```{r}
z221_X1 = subset(X, cust %in% z221_cu_A1$cust & date < as.Date("2001-02-01"))
z221_Z1 = subset(Z, cust %in% z221_cu_A1$cust & date < as.Date("2001-02-01"))
set.seed(2018)
z221_spl = sample.split(z221_cu_A1$buy, SplitRatio = 0.7)
c(nrow(z221_cu_A1),sum(z221_spl),sum(!z221_spl))
```

```{r}
#TRå’ŒTSä¹‹ä¸­buy==TRUEçš„æ¯”ä¾‹æ˜¯ä¸€è‡´çš„
tapply(z221_cu_A1$buy,z221_spl,mean)
```

```{r}
cbind(z221_cu_A1, z221_spl) %>% filter(buy) %>%
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=z221_spl), alpha=0.5)
```

**z221çš„è³¼è²·é‡‘é¡æ¨¡å‹**
```{r}
z221_A2 = subset(z221_cu_A1, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(z221_A2)
#éš¨æ©ŸæŠ½æ¨£è£½ä½œåˆ†å‰²å‘é‡spl2
set.seed(2018); z221_spl2 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(z221_A2), sum(z221_spl2), sum(!z221_spl2))
```

```{r}
mean(z221_spl2)
```

```{r}
cbind(z221_A2, z221_spl2) %>% 
  ggplot(aes(x=amount)) + geom_density(aes(fill=z221_spl2), alpha=0.5)
```

##### 2.å„²å­˜åšå¥½çš„è³‡æ–™
```{r}
save(z115_Z1, z115_X1, z115_cu_A1, z115_spl, z115_spl2, file="data/tf_z115.rdata")
save(z221_Z1, z221_X1, z221_cu_A1, z221_spl, z221_spl2, file="data/tf_z221.rdata")
```


<hr>
### æ¨¡å‹èˆ‡é æ¸¬
### 1.åŒ¯å…¥å‰›å„²å­˜çš„è³‡æ–™
```{r}
load("data/tf_z115.rdata")
load("data/tf_z221.rdata")
```

**ä½¿ç”¨splåˆ‡å‰²æ©Ÿç‡æ¨¡å‹çš„è¨“ç·´(TR)èˆ‡æ¸¬è©¦è³‡æ–™(TS)**

```{r}
z115_TR = subset(z115_cu_A1,z115_spl)
z115_TS = subset(z115_cu_A1,!z115_spl)
```

```{r}
z221_TR = subset(z221_cu_A1,z221_spl)
z221_TS = subset(z221_cu_A1,!z221_spl)
```


### 2.è³¼è²·æ©Ÿç‡æ¨¡å‹

**z115ç›®æ¨™å®¢ç¾¤çš„æ¸¬è©¦è³‡æ–™é æ¸¬** 
```{r}
z115_glm1 = glm(buy ~ ., z115_TR[,c(3:9,12)], family=binomial()) 
summary(z115_glm1)
```

```{r}
z115_pred = predict(z115_glm1, z115_TS, type = "response")
z115_cm = table(actual = z115_TS$buy, predict = z115_pred > 0.5);z115_cm
```

```{r}
z115_acc.ts = z115_cm %>% {sum(diag(.))/sum(.)}
c(1-mean(z115_TS$buy) , z115_acc.ts)  # 0.6880734 
```

```{r}
colAUC(z115_pred, z115_TS$buy)  #è¾¨è­˜ç‡é”0.7513722
```

**z221ç›®æ¨™å®¢ç¾¤çš„æ¸¬è©¦è³‡æ–™é æ¸¬**  
```{r}
z221_glm1 = glm(buy ~ ., z221_TR[,c(3:9,12)], family=binomial()) 
summary(z221_glm1)
```

```{r}
z221_pred = predict(z221_glm1, z221_TS, type = "response")
z221_cm = table(actual = z221_TS$buy, predict = z221_pred > 0.5);z221_cm
```

```{r}
z221_acc.ts = z221_cm %>% {sum(diag(.))/sum(.)}
c(1-mean(z221_TS$buy) , z221_acc.ts)  # 0.6776567 
```

```{r}
colAUC(z221_pred, z221_TS$buy)  #è¾¨è­˜ç‡é”0.7369989
```


### 3.è³¼è²·é‡‘é¡æ¨¡å‹

**z115å®¢ç¾¤é æ¸¬æœªä¾†è³¼è²·é‡‘é¡**
```{r}
z115_A2 = subset(z115_cu_A1, z115_cu_A1$buy) %>% mutate_at(c("m","rev","amount"), log10)
z115_TR2 = subset(z115_A2, z115_spl2)
z115_TS2 = subset(z115_A2, !z115_spl2)
```

```{r}
z115_lm1 = lm(amount ~ ., z115_TR2[,c(3:9,11)])
summary(z115_lm1)
```

```{r}
z115_r2.tr = summary(z115_lm1)$r.sq
z115_SST = sum((z115_TS2$amount - mean(z115_TR2$amount))^ 2)
z115_SSE = sum((predict(z115_lm1, z115_TS2) -  z115_TS2$amount)^2)
z115_r2.ts = 1 - (z115_SSE/z115_SST)
c(z115_R2train=z115_r2.tr, z115_R2test=z115_r2.ts)#æ¨¡å‹å¯ä»¥è§£é‡‹testing dataset å°‡è¿‘2æˆçš„è®Šç•°
```

**z221å®¢ç¾¤é æ¸¬æœªä¾†è³¼è²·é‡‘é¡**
```{r}
z221_A2 = subset(z221_cu_A1, z221_cu_A1$buy) %>% mutate_at(c("m","rev","amount"), log10)
z221_TR2 = subset(z221_A2, z221_spl2)
z221_TS2 = subset(z221_A2, !z221_spl2)
```

```{r}
z221_lm1 = lm(amount ~ ., z221_TR2[,c(3:9,11)])
summary(z221_lm1)
```

```{r}
z221_r2.tr = summary(z221_lm1)$r.sq
z221_SST = sum((z221_TS2$amount - mean(z221_TR2$amount))^ 2)
z221_SSE = sum((predict(z221_lm1, z221_TS2) -  z221_TS2$amount)^2)
z221_r2.ts = 1 - (z221_SSE/z221_SST)
c(z221_R2train=z221_r2.tr, z221_R2test=z221_r2.ts)#æ¨¡å‹å¯ä»¥è§£é‡‹testing dataset å°‡è¿‘2æˆçš„è®Šç•°
```

### 4.é æ¸¬æœªä¾†é¡§å®¢è¡Œç‚º
```{r}
load("data/tf0.rdata")
d0 = max(X0$date) + 1
B = X0 %>% 
  filter(date >= as.Date("2000-12-01")) %>% 
  mutate(days = as.integer(difftime(d0, date, units="days"))) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frequency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = age[1],       # age group
    area = area[1],     # area code
    TID = min(tid)
  ) %>% data.frame      # 28531
nrow(B)
```
```{r}
z115_B = matrix(NA, nrow(z115_cu),ncol(z115_cu))
z115_B = B[B$TID %in% z115_cu$TID,]
```


```{r}
z221_B = matrix(NA, nrow(z221_cu),ncol(z221_cu))
z221_B = B[B$TID %in% z221_cu$TID,]
```


##### 3æœˆä»½ä¾†è²·çš„æ©Ÿç‡
**z115è³¼è²·æ©Ÿç‡**
```{r}
z115_B$Buy = predict(z115_glm1, z115_B, type="response")#3æœˆä»½ä¾†è²·çš„æ©Ÿç‡
```

```{r}
z115_B2 = z115_B %>% mutate_at(c("m","rev"), log10)
z115_B$Rev = 10^predict(z115_lm1, z115_B2)
#"m","rev"å…©å€‹è®Šæ•¸å’Œç›®æ¨™è®Šæ•¸å–log
#"rev"ç‚ºé æœŸè³¼è²·é‡‘é¡
par(mfrow=c(1,2), cex=0.8)
hist(z115_B$Buy)
hist(log(z115_B$Rev,10))
```

```{r}
save(z115_B, file='data/tf4_z115.rdata')
```

**z221è³¼è²·æ©Ÿç‡**
```{r}
z221_B$Buy = predict(z221_glm1, z221_B, type="response")
```

```{r}
z221_B2 = z221_B %>% mutate_at(c("m","rev"), log10)
z221_B$Rev = 10^predict(z221_lm1, z221_B2)
#"m","rev"å…©å€‹è®Šæ•¸å’Œç›®æ¨™è®Šæ•¸å–log
#"rev"ç‚ºé æœŸè³¼è²·é‡‘é¡
par(mfrow=c(1,2), cex=0.8)
hist(z221_B$Buy)
hist(log(z221_B$Rev,10))
```

```{r}
save(z221_B, file='data/tf4_z221.rdata')
```


### é¡§å®¢çµ‚èº«åƒ¹å€¼è¨ˆç®—  
æ¥è‘—é€éè¨ˆç®—é¡§å®¢çµ‚ç”Ÿåƒ¹å€¼ç­è§£æ¯ä¸€å€‹é¡§å®¢çš„æ½›åœ¨åƒ¹å€¼æœ‰å¤šå¤§ã€‚
![Fig-3:CLV](fig/CLV.png)

##### z115å®¢ç¾¤çš„æœªä¾†3å¹´çš„çµ‚èº«åƒ¹å€¼
```{r}
g = 0.3   # margin
N = 36    # period(ä¸€æœŸä¸€å€‹æœˆ)
d = 0.01  # interest rate
z115_B$CLV = g * z115_B$Rev * rowSums(sapply(
  0:N, function(i) (z115_B$Buy/(1+d))^i ) )

summary(z115_B$CLV)#è©²é¡§å®¢çš„çµ‚ç”Ÿåƒ¹å€¼ï¼Œæœªä¾†3å¹´çš„ç‡Ÿæ”¶è²¢ç»
```

```{r}
ggplot(z115_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()
```

##### z221å®¢ç¾¤çš„æœªä¾†3å¹´çš„çµ‚èº«åƒ¹å€¼
```{r}
g = 0.3   # margin
N = 36    # period(ä¸€æœŸä¸€å€‹æœˆ)
d = 0.01  # interest rate
z221_B$CLV = g * z221_B$Rev * rowSums(sapply(
  0:N, function(i) (z221_B$Buy/(1+d))^i ) )

summary(z221_B$CLV)#è©²é¡§å®¢çš„çµ‚ç”Ÿåƒ¹å€¼ï¼Œæœªä¾†3å¹´çš„ç‡Ÿæ”¶è²¢ç»
```

```{r}
ggplot(z221_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()
```

### å¸¶åƒæ•¸çš„å‡è¨­
**Sæ›²ç·š**  
- S-Curve : è¨±å¤šç®¡ç†å·¥å…·éƒ½å‘ˆç¾Så‹çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸  
- ä»¥Rå…§å»ºçš„é‚è¼¯å¼å‡½æ•¸(plogis())ä¾†æ¨¡æ“¬Sæ›²ç·š
$$\Delta P(x|m,b,a) = m \cdot Logis(\frac{10(x - b)}{a})$$

```{r}
DP = function(x,m0,b0,a0) {m0*plogis((10/a0)*(x-b0))}
par(mar=c(4,4,2,1),cex=0.7)
curve(DP(x,m=0.20,b=30,a=40), 0, 60, lwd=2, ylim=c(0, 0.25),
      main="F( x | m=0.2, b=30, a=40 )", ylab="delta P")
abline(h=seq(0,0.2,0.05),v=seq(0,60,5),col='lightgrey',lty=2)
```

![Fig-44:CLV](fig/EffectFunition.png)
**é€éé€™3å€‹parameters(åƒæ•¸):**

- m : æœ€å¤§æ•ˆæœ
- b : æ•ˆæœçš„ä½ç½®(ä¸Šå‡æ³¢æ®µçš„ä¸­é»)
- a : æ•ˆæœçš„ç¯„åœ(ä¸Šå‡æ³¢æ®µçš„å¯¬åº¦)    
æˆ‘å€‘å¯ä»¥å¯«ã€ä¸€æ”¯ç¨‹å¼ã€ä¾†æ¨¡æ“¬ã€æ‰€æœ‰å¯èƒ½ã€çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸(Sæ›²ç·š),è—‰ä»¥æè¿°ç­–ç•¥è®Šæ•¸(x,æŠ˜åƒ¹å·é¢é¡)å’Œç­–ç•¥æ•ˆæœ(Î”P,è³¼è²·æ©Ÿç‡å¢å¹…)ä¹‹é–“çš„é—œä¿‚

##### ä¼°è¨ˆé æœŸç²åˆ©
æœ‰äº†è¡ŒéŠ·å·¥å…·çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆå°‡é€™å€‹å·¥å…·ç”¨åœ¨æ¯ä¸€ä½é¡§å®¢ä¸Šçš„æ™‚å€™çš„é æœŸæ•ˆç›Š:  

$$\hat{R}(x) = \left\{\begin{matrix}
\Delta P \cdot M \cdot margin - x & , & P + \Delta P \leq 1\\ 
(1-P) \cdot M \cdot margin - x & , & else 
\end{matrix}\right.$$

çµåˆä»¥ä¸‹ï¼Œ 
- é æ¸¬ ($P, M$) : æ¯ä½é¡§å®¢çš„é æœŸè³¼è²·æ©Ÿç‡å’Œè³¼è²·é‡‘é¡ï¼Œ
- å‡è¨­ ($\Delta P(x|m,b,a)$) : è¡ŒéŠ·å·¥å…·å¸¶ä¾†çš„å†è³¼æ©Ÿç‡å¢é¡
æˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆé€™å€‹å·¥å…·ç”¨åœ¨æ¯ä½é¡§å®¢ä¸Šçš„é æœŸæ•ˆç›Š $\hat{R}(x)$ã€‚ 


ğŸŒ» æ³¨æ„$\Delta P$ å’Œ $\hat{R}$ éƒ½æ˜¯è—‰ç”±å‡½æ•¸ $x$ çš„ $m,b,a$ æ‰€å¾—åˆ°

+ $P, M$ é æœŸè³¼è²·æ©Ÿç‡å’Œé‡‘é¡ï¼Œæ˜¯<z>é æ¸¬</z>
+ $m, b, a$ è¡ŒéŠ·å·¥å…·çš„å±¬æ€§ï¼Œæ˜¯<z>å‡è¨­</z>
+ $x$ è¡ŒéŠ·å¼·åº¦ï¼Œæ˜¯æˆ‘å€‘å¯ä»¥æ“ä½œçš„ã€æƒ³è¦å„ªåŒ–çš„<z>ç­–ç•¥è®Šæ•¸</z>

##### ä¼°è¨ˆæ¯›åˆ©ç‡ m
```{r}
margin = 0.17  # assume margin = 0.17
```

##### ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š

**z221å®¢ç¾¤çš„æ·¨æ”¶ç›Š**
```{r}
#z115æ—å®¢ç¾¤çš„ç¤ºæ„åœ–(æ”¹mba)
m=0.25; b=20; a=30; x=27
z115_dp = pmin(1-z115_B$Buy, DP(x,m,b,a))
z115_eR = z115_dp*z115_B$Rev*margin - x
hist(z115_eR,main="TA1é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ(m=0.20; b=20; a=30;x=27)",xlab="z115_a3439é æœŸæ·¨æ”¶ç›Š",ylab="z115_a3439é¡§å®¢äººæ•¸")
```


**z221å®¢ç¾¤çš„æ·¨æ”¶ç›Š**
```{r}
#z221æ—ç¾¤çš„ç¤ºæ„åœ–(æ”¹mba)
m=0.2; b=20; a=30; x=27
z221_dp = pmin(1-z221_B$Buy, DP(x,m,b,a))
z221_eR = z221_dp*z221_B$Rev*margin - x
hist(z221_eR,main="TA2é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ(m=0.20; b=20; a=30;x=27)",xlab="z221_a3439é æœŸæ·¨æ”¶ç›Š",ylab="z221_a3439é¡§å®¢äººæ•¸")
```

### å¸‚å ´æ¨¡æ“¬
ä¸€å€‹è¡ŒéŠ·å·¥å…·çµ¦å®šå·¥å…·åƒæ•¸(m,b,a)ï¼Œæˆ‘å€‘å¯åœ¨å…¶æœ‰æ•ˆæˆæœ¬ç¯„åœ(xâˆˆ[bâˆ’a2,b+a2] )ä¹‹å…§ï¼Œä¼°è¨ˆå·¥å…·çš„æ•ˆæœï¼š
- eReturn : å°æ‰€æœ‰çš„äººè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š 
- N : é æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººæ•¸
- eReturn2 : åªå°æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººåšè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Šå¦‚ä½•éš¨æˆæœ¬è®ŠåŒ–ã€‚

##### åŸºæœ¬æŠ˜åƒ¹åˆ¸ã€ç´¯é»è¡ŒéŠ·å·¥å…·æ¨¡æ“¬
```{r}
mm=c(0.15, 0.25)
bb=c(  10,   25)
aa=c(  20,   30)
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst = ifelse(i == 1, "æŠ˜åƒ¹åˆ¸", "ç´¯é»"), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```

##### å·¥å…·æ¨¡æ“¬å°æ–¼z115çš„æ•ˆæœ
```{r}
mm=c(0.2, 0.25)
bb=c(  20,   20)
aa=c(  30,   20)
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst = ifelse(i == 1, "æŠ˜åƒ¹åˆ¸", "ç´¯é»"), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```


```{r}
X = seq(10, 60, 1) 
df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    z115_dp = pmin(1-z115_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    z115_eR = z115_dp*z115_B$Rev*margin - x
    c(i=i, x=x, z115_eR.ALL=sum(z115_eR), N=sum(z115_eR>0), z115_eR.SEL=sum(z115_eR[z115_eR > 0]) )
    }) %>% t %>% data.frame
  })) 

df %>% 
  mutate_at(vars(z115_eR.ALL, z115_eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Inst = ifelse(i == 1, "æŠ˜åƒ¹åˆ¸", "ç´¯é»")) %>%
  ggplot(aes(x=x, y=value, col=Inst)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> p

plotly::ggplotly(p)
```


```{r}
group_by(df, i) %>% top_n(1,z115_eR.SEL)
```
##### å·¥å…·æ¨¡æ“¬å°æ–¼z221çš„æ•ˆæœ
```{r}
mm=c(0.25, 0.2)
bb=c(  15,   25)
aa=c(  20,   30)
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst = ifelse(i == 1, "æŠ˜åƒ¹åˆ¸", "ç´¯é»"), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```

```{r}
X = seq(10, 60, 1) 
df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    z221_dp = pmin(1-z221_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    z221_eR = z221_dp*z221_B$Rev*margin - x
    c(i=i, x=x, z221_eR.ALL=sum(z221_eR), N=sum(z221_eR>0), z221_eR.SEL=sum(z221_eR[z221_eR > 0]) )
    }) %>% t %>% data.frame
  })) 

df %>% 
  mutate_at(vars(z221_eR.ALL, z221_eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Inst = ifelse(i == 1, "æŠ˜åƒ¹åˆ¸", "ç´¯é»")) %>%
  ggplot(aes(x=x, y=value, col=Inst)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> p

plotly::ggplotly(p)
```


### æœ€å¾Œçµæœ
æ ¹æ“šé æœŸçš„ç¸½æ•ˆç›Šé¡¯ç¤ºï¼Œæœ‰äº†ä»¥ä¸‹çš„è¡ŒéŠ·ç­–ç•¥:  
1. é›†é»åŠ è³¼é€é‹å…·é©ç”¨æ–¼z115(å—æ¸¯)çš„å®¢ç¾¤ï¼Œç¸½è§¸åŠäººæ•¸æœ‰962äººï¼Œé æœŸæ•ˆç›Šç‚º17144ã€‚
2. æ»¿åƒé€95æŠ˜æŠ˜åƒ¹åˆ¸(è¦å®šæ–¼ä¸‹æ¬¡ä½¿ç”¨)å‰‡é©ç”¨æ–¼z221çš„å®¢ç¾¤(æ±æ­¢å€)ï¼Œç¸½è§¸åŠæœƒæœ‰1352äººï¼Œé æœŸæ•ˆç›Š30366ã€‚   
æ•…ç¸½è§¸åŠäººæ•¸æœƒæœ‰2314äººï¼Œç¸½çµæ•ˆç›Šç‚º47510ã€‚

